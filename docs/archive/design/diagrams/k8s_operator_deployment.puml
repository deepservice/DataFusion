@startuml k8s_operator_deployment

skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 11

' Kubernetes集群边界
rectangle "Kubernetes集群" #326CE5 {

  ' datafusion-system命名空间
  package "命名空间: datafusion-system" #00897B {
    rectangle "Operator Manager\n(Deployment, 2副本)" as OM {
      card "Pod 1\n(Leader)" as OM1
      card "Pod 2\n(Standby)" as OM2
    }

    database "CRD定义" {
      [CollectionTask]
      [DataSource]
      [CleaningRule]
    }

    note right of OM
      - Leader Election
      - Reconcile循环
      - Webhook验证
    end note
  }

  ' datafusion命名空间
  package "命名空间: datafusion" #00897B {
    rectangle "CollectionTask CR实例" as CR {
      card "task-web-001"
      card "task-api-002"
      card "task-db-003"
    }

    database "PostgreSQL Control Center" #E1F5FE {
      [collection_tasks\n(任务配置)]
      [task_executions\n(执行记录)]
      [task_locks\n(分布式锁)]
    }

    rectangle "Deployment Collectors\n(常驻Worker)" #FF6F00 {
      card "RPA Collector\n(replicas=1-3)" as RPAWorker
      card "API Collector\n(replicas=1-2)" as APIWorker
      card "DB Collector\n(replicas=1)" as DBWorker
    }

    database "PostgreSQL\n(业务数据)" {
      [采集数据表]
      [数据分析结果]
    }

    rectangle "Secret" {
      [数据源凭证]
      [数据库密码]
    }
  }

  ' datafusion-monitor命名空间
  package "命名空间: datafusion-monitor" #00897B {
    rectangle "Prometheus\n(Deployment)" as PROM
    rectangle "Grafana\n(Deployment)" as GRAF
    rectangle "AlertManager\n(Deployment)" as ALERT
  }

  ' K8S原生组件
  cloud "K8S原生能力" {
    database "etcd\n(CRD状态存储)"
    [API Server]
    [Scheduler]
    [Controller Manager]
  }
}

' 外部访问
actor "用户/系统" as User
[kubectl / K8S API] as CLI

' 连接关系
User --> CLI
CLI --> [API Server]

[API Server] <--> OM : list-watch
[API Server] <--> etcd
OM --> CR : 创建/更新
OM --> [PostgreSQL Control Center] : syncCRToDB()\n同步配置
[Deployment Collectors\n(常驻Worker)] --> [PostgreSQL Control Center] : 轮询任务(30s)\n抢锁执行
[PostgreSQL Control Center] --> OM : syncDBToStatus()\n状态回传
[Deployment Collectors\n(常驻Worker)] --> [PostgreSQL\n(业务数据)] : 存储数据
[Deployment Collectors\n(常驻Worker)] --> Secret : 读取凭证
[Deployment Collectors\n(常驻Worker)] --> PROM : 上报Metrics
OM --> PROM : 上报Metrics
PROM --> GRAF : 数据查询
PROM --> ALERT : 告警规则

note bottom of [Deployment Collectors\n(常驻Worker)]
  - Deployment常驻
  - 轮询PostgreSQL执行任务
  - 内置资源池(浏览器/连接)
  - 分布式锁防重复执行
end note

legend right
  |= 组件类型 |= 说明 |
  | CRD | 自定义资源定义 |
  | Operator | 自定义控制器 |
  | Deployment | 常驻Pod管理 |
  | PostgreSQL | 任务配置中心 |
  | Worker | 常驻采集器 |
endlegend

@enduml
