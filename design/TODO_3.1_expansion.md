# DataFusion技术方案设计 3.1节扩展任务追踪

## 任务目标
将产品需求分析文档中的11个用户场景转化为14个技术时序图，扩展技术方案设计文档的3.1节。

## 总体进度: 1/14 (7%)

---

## Session 1 进度 (2025-10-25)

### ✅ 已完成 (1个时序图)

1. **3.1节结构重构**
   - ✅ 添加分组标题和总体说明
   - ✅ 重新组织章节结构为4大类
   - 文件位置: 第389-602行

2. **3.1.1.1 网页数据源配置与RPA采集流程** ✅
   - 场景描述: 用户配置网页数据源，使用RPA测试采集
   - 参与组件: 9个（WebUI, Gateway, Master, PostgreSQL, RabbitMQ, Worker, Playwright, Website等）
   - PlantUML代码: 完整的时序图（约140行）
   - 关键技术点: 6个方面（异步执行、RPA引擎、数据提取、错误处理、性能优化、安全性）
   - 文件位置: 第403-602行
   - 图片引用: `diagrams/seq_web_rpa_collection.png`

### 🔄 进行中

**3.1.1.2 数据库数据源配置与同步流程** (待继续)

---

## Session 2 待完成任务

### 📋 3.1.1 数据采集场景（剩余3个）

#### 3.1.1.2 数据库数据源配置与同步流程
- **场景描述**: 用户配置数据库数据源（MySQL/PostgreSQL），测试连接和SQL查询
- **参与组件**: WebUI, Gateway, Master, PostgreSQL(配置库), Worker, Source Database
- **关键流程**:
  1. 用户配置连接信息（类型、主机、端口、认证）
  2. 系统测试连接
  3. 用户配置SQL查询（支持变量如{start_date}）
  4. 系统执行测试查询，返回预览数据
  5. 用户配置字段映射（源→目标）
  6. 配置增量同步策略（可选）
- **关键技术点**:
  - 连接池管理（HikariCP）
  - SQL注入防护（参数化查询）
  - 增量同步算法（基于时间戳/ID）
  - 大数据量分批处理（游标/LIMIT OFFSET）
  - 事务隔离级别控制
  - 跨数据库兼容性（支持MySQL、PostgreSQL、Oracle等）

#### 3.1.1.3 API数据源配置与采集流程
- **场景描述**: 用户配置RESTful API数据源，测试API调用和数据提取
- **参与组件**: WebUI, Gateway, Master, PostgreSQL, Worker, Target API
- **关键流程**:
  1. 用户配置API端点（URL、HTTP方法）
  2. 用户配置认证方式（API Key、OAuth2、Basic Auth）
  3. 用户配置请求参数（Query/Body/Header）
  4. 用户配置响应数据路径（JSONPath表达式）
  5. 用户配置分页策略（Page/Offset、Cursor、Link Header）
  6. 系统测试API调用
  7. 返回响应数据预览和schema推断
- **关键技术点**:
  - HTTP客户端选型（resty for Go）
  - OAuth2.0流程实现（Authorization Code、Client Credentials）
  - JSONPath解析引擎（gjson）
  - 分页策略自动检测
  - Rate Limiting遵守（429重试、X-RateLimit头解析）
  - 响应schema自动推断

#### 3.1.1.4 页面DOM解析与智能字段识别流程
- **场景描述**: 用户输入URL，系统自动解析页面结构，智能识别数据字段
- **参与组件**: WebUI, Gateway, Master, Worker, Playwright, AI识别引擎
- **关键流程**:
  1. 用户输入目标URL，点击"预览页面"
  2. Worker启动RPA引擎，渲染页面
  3. 生成DOM结构树JSON和页面截图
  4. AI引擎分析DOM结构，识别重复模式（列表项）
  5. AI引擎识别常见字段类型（标题、日期、作者、内容）
  6. 生成推荐的CSS选择器/XPath
  7. 返回智能识别结果（字段名、选择器、置信度、数据示例）
  8. 用户确认或调整规则
- **关键技术点**:
  - DOM树序列化（保留结构和属性）
  - 重复模式识别算法（LCS最长公共子序列）
  - 字段类型推断（基于元素标签、class、文本模式）
  - CSS选择器自动生成（最短唯一路径）
  - 置信度评分（基于字段数量、结构一致性）
  - 可选：集成轻量级NLP模型（字段语义理解）

---

## Session 3 待完成任务

### 📋 3.1.2 任务管理场景（4个）

#### 3.1.2.1 定时任务创建与调度流程（重构已有）
- 基于现有的"任务创建场景"重构
- 补充Cron表达式解析细节
- 增加etcd分布式锁（防止重复调度）
- 增加调度器状态机

#### 3.1.2.2 任务执行流程（重构已有）
- 基于现有的"任务执行场景"重构
- 保持核心流程
- 补充Worker健康检查
- 补充任务优先级队列细节

#### 3.1.2.3 手动触发任务执行流程
- **场景描述**: 用户在Web UI点击"立即执行"，手动触发任务
- **关键流程**: 权限验证 → 任务状态检查 → 推送到高优先级队列 → WebSocket实时日志
- **关键技术点**: WebSocket推送、任务去重、并发控制

#### 3.1.2.4 任务失败重试与告警流程
- **场景描述**: 任务执行失败后的自动重试和告警通知
- **关键流程**: 失败检测 → 读取重试策略 → 延迟重试/标记最终失败 → 告警评估 → 多渠道通知
- **关键技术点**: 指数退避算法、告警规则引擎、多渠道通知（邮件/短信/钉钉/企业微信）

---

## Session 4 待完成任务

### 📋 3.1.3 数据处理场景（3个）

#### 3.1.3.1 数据清洗规则配置与执行流程
- **场景描述**: 用户为数据源配置清洗规则，Worker自动应用
- **关键流程**: 配置规则 → 测试预览 → 保存 → Worker执行时应用
- **关键技术点**: 清洗规则DSL（expr引擎）、管道式处理

#### 3.1.3.2 数据查询与导出流程
- **场景描述**: 用户查询采集数据，应用筛选，导出CSV
- **关键流程**: 查询参数 → 分页查询 → 应用筛选 → 生成CSV → 返回下载链接
- **关键技术点**: 高效分页、流式导出、临时文件清理

#### 3.1.3.3 错误数据标记与重新采集流程
- **场景描述**: 用户标记错误数据，触发重新采集
- **关键流程**: 标记错误 → 创建补采任务 → Worker重新采集 → 更新记录
- **关键技术点**: 数据版本管理、幂等性保证

---

## Session 5 待完成任务

### 📋 3.1.4 系统集成场景（3个）

#### 3.1.4.1 MCP协议资源发现与数据查询流程
- **场景描述**: AI应用通过MCP协议发现资源和查询数据
- **关键流程**: resources/list → data/query → 返回标准JSON
- **关键技术点**: MCP Go SDK集成、标准化数据格式

#### 3.1.4.2 MCP数据订阅与实时推送流程
- **场景描述**: AI应用订阅数据更新，自动推送新数据
- **关键流程**: subscribe → 订阅管理 → 数据采集完成 → WebSocket推送
- **关键技术点**: 订阅管理（Redis）、推送条件匹配、WebSocket连接池

#### 3.1.4.3 移动端任务监控与推送通知流程
- **场景描述**: 移动端接收任务失败推送，快速重试
- **关键流程**: 注册设备Token → 任务失败 → Firebase/APNs推送 → 点击跳转 → 手动重试
- **关键技术点**: Firebase Cloud Messaging、APNs集成、Deep Link

---

## 如何继续下一个Session

### 方式1: 直接继续（推荐）
在新session中直接说：
```
继续完成DataFusion技术方案设计文档3.1节的扩展任务。
请查看 design/TODO_3.1_expansion.md 了解当前进度，
从3.1.1.2 数据库数据源配置与同步流程开始。
```

### 方式2: 提供上下文
```
我正在扩展DataFusion技术方案设计文档的3.1节，
已完成3.1.1.1网页RPA采集时序图。
现在需要继续添加3.1.1.2数据库同步时序图。
详细计划见design/TODO_3.1_expansion.md。
```

---

## 注意事项

1. **保持PlantUML格式一致**
   - 使用 `!theme plain` 和白色背景
   - 使用 `autonumber` 自动编号
   - 使用 `note` 添加关键说明
   - 参与者命名清晰（如 "Master\nDataSource Service"）

2. **每个时序图包含的要素**
   - 场景描述（2-3句话）
   - 参与组件列表
   - 时序图（PlantUML代码块）
   - 图片引用（`![场景名](diagrams/xxx.png)`）
   - 关键技术点（6个左右，有序列表）

3. **插入位置**
   - 所有时序图插入到 3.1 节
   - 3.2 节（核心模块设计）保持不变
   - 最后一行应该是 `---` 分隔符

4. **文件备份**
   - 每完成一个session后提交Git
   - commit message格式: `feat: 添加3.1.x场景时序图(进度x/14)`

---

## 预计工作量

- **每个时序图**: 约120-200行（含PlantUML代码、说明、技术点）
- **总预计**: 1500-2000行
- **Session划分**:
  - Session 1: 已完成1个，剩余约150行可完成3个 = 共4个（3.1.1完成）
  - Session 2: 4个（3.1.2完成）
  - Session 3: 3个（3.1.3完成）
  - Session 4: 3个（3.1.4完成）

---

## 最后更新
- **日期**: 2025-10-25
- **最后完成**: 3.1.1.1 网页数据源配置与RPA采集流程
- **下一步**: 3.1.1.2 数据库数据源配置与同步流程
