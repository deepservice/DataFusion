@startuml
title 任务执行时序图 (Deployment常驻Worker架构)

skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

participant "Operator\nController" as operator
participant "CollectionTask\nCR" as cr
database "PostgreSQL\nControl Center" as controldb
participant "Worker Pod\n(Deployment)" as worker
participant "Collector\nEngine" as collector
participant "Data Processor" as processor
participant "Storage\nEngine" as storage
database "Target DB/Storage" as target
participant "Prometheus" as prom

autonumber

== 配置下发阶段 ==

operator -> operator: Watch CollectionTask CR变化
activate operator

operator -> cr: Get CollectionTask
activate cr
cr --> operator: task配置\n{name, spec, generation}
deactivate cr

operator -> controldb: syncCRToDB()\nINSERT/UPDATE collection_tasks
activate controldb
note right of controldb
  表字段:
  - cr_uid (CR唯一标识)
  - task_name
  - collector_type, collector_config
  - parsing_rules, cleaning_rules
  - cron_schedule, next_run_time
  - enabled (基于CR.Suspended状态)
end note
controldb --> operator: 配置同步成功
deactivate controldb

operator -> operator: 更新CR.Status.Phase = Active
deactivate operator

== Worker轮询阶段 ==

worker -> worker: 定时器触发(每30秒)
activate worker

worker -> controldb: SELECT * FROM collection_tasks\nWHERE enabled=true\nAND next_run_time <= NOW()\nFOR UPDATE SKIP LOCKED\nLIMIT 1
activate controldb
note right of controldb
  分布式锁机制:
  - FOR UPDATE SKIP LOCKED
  - 多个Worker并发查询
  - 只有一个Worker获取到锁
  - 其他Worker跳过已锁定的任务
end note
controldb --> worker: 返回待执行任务\n{task_id, collector_config, ...}
deactivate controldb

alt 获取锁成功

    worker -> controldb: BEGIN TRANSACTION
    activate controldb

    ' 创建执行记录
    worker -> controldb: INSERT INTO task_executions\n(id, cr_uid, task_id, status='running',\nstart_time=NOW(), worker_pod='{POD_NAME}')
    controldb --> worker: execution_id

    ' 更新next_run_time
    worker -> controldb: UPDATE collection_tasks\nSET next_run_time = calculate_next(cron),\nlast_run_at = NOW()
    controldb --> worker: OK

    worker -> controldb: COMMIT TRANSACTION
    controldb --> worker: Transaction Committed
    deactivate controldb

    == 数据采集阶段 ==

    worker -> collector: Execute(config)
    activate collector

    note right of collector
      Worker内置资源池:
      - 浏览器池(RPA): 预初始化5个浏览器实例
      - HTTP连接池(API): MaxIdleConns=100
      - DB连接池: MaxOpenConns=25

      **性能优势**:
      - 消除容器启动开销(5-8秒)
      - 消除浏览器初始化开销(3-5秒)
      - 复用连接,降低延迟
    end note

    alt 网页RPA采集
        collector -> collector: 从浏览器池获取实例\n(复用,无需重启)
        collector -> collector: 渲染页面,提取数据
        collector --> worker: 原始HTML数据

    else 数据库采集
        collector -> collector: 从连接池获取连接
        collector -> collector: 执行SQL查询
        collector --> worker: 查询结果集

    else API采集
        collector -> collector: HTTP连接池复用
        collector -> collector: 处理分页/限流
        collector --> worker: JSON响应数据
    end

    deactivate collector

    == 数据处理阶段 ==

    worker -> processor: Process(raw_data, rules)
    activate processor

    processor -> processor: 数据解析\n(HTML/JSON/XML)
    processor -> processor: 字段提取\n(XPath/JSONPath/CSS)
    processor -> processor: 数据清洗\n(去标签/格式转换/去重)
    processor -> processor: 数据验证\n(schema校验/业务规则)

    note right of processor
      处理管道(Pipeline):
      1. Parse: 解析原始格式
      2. Extract: 提取字段
      3. Clean: 清洗数据
      4. Validate: 验证质量
      5. Transform: 格式转换
    end note

    processor --> worker: 处理后的结构化数据\n{records: [...], stats: {...}}
    deactivate processor

    == 数据存储阶段 ==

    worker -> storage: Store(processed_data, config)
    activate storage

    alt 存储成功
        storage -> target: BEGIN TRANSACTION
        activate target

        storage -> target: UPSERT INTO target_table\nVALUES (...)\nON CONFLICT DO UPDATE
        target --> storage: 插入/更新成功 (N rows)

        storage -> target: COMMIT TRANSACTION
        target --> storage: Transaction Committed
        deactivate target

        storage --> worker: 存储成功\n{count: N, duplicates: M}
        deactivate storage

        ' 更新执行记录为成功
        worker -> controldb: UPDATE task_executions\nSET status='success',\nend_time=NOW(),\nrecords_fetched=N,\nrecords_stored=N-M,\nerror_message=NULL
        activate controldb
        controldb --> worker: OK
        deactivate controldb

        ' 上报Metrics
        worker -> prom: datafusion_task_execution_total\n{collector_type, task_name, status="success"}++
        activate prom
        worker -> prom: datafusion_records_stored_total\n{collector_type, task_name} += N
        prom --> worker: Metrics Recorded
        deactivate prom

    else 存储失败
        storage -> target: ROLLBACK TRANSACTION
        activate target
        target --> storage: Rolled Back
        deactivate target

        storage --> worker: 存储失败\n{error: "connection timeout"}
        deactivate storage

        ' 记录失败信息
        worker -> controldb: UPDATE task_executions\nSET status='failed',\nend_time=NOW(),\nerror_message='...',\nretry_count=retry_count+1
        activate controldb
        controldb --> worker: OK
        deactivate controldb

        ' 上报失败Metrics
        worker -> prom: datafusion_task_execution_total\n{collector_type, task_name, status="failed"}++
        activate prom
        prom --> worker: Metrics Recorded
        deactivate prom

        note right of worker
          重试策略:
          - Worker会在下次轮询时
            自动重试(基于next_run_time)
          - 无需额外的重试队列
          - 失败任务的next_run_time
            会被重新计算
        end note
    end

else 获取锁失败 (其他Worker已锁定)
    worker -> worker: 跳过该任务,继续轮询下一个
    note right: SKIP LOCKED确保无阻塞
end

deactivate worker

== 状态回传阶段 ==

operator -> operator: 定时Reconcile触发\n(每1分钟)
activate operator

operator -> controldb: syncDBToStatus()\nSELECT * FROM task_executions\nWHERE cr_uid = '{uid}'\nORDER BY start_time DESC LIMIT 1
activate controldb
controldb --> operator: 最新执行记录\n{status, start_time, records_stored, ...}
deactivate controldb

operator -> cr: Update CR.Status
activate cr
note right of cr
  更新字段:
  - LastScheduleTime
  - LastSuccessTime / LastFailureTime
  - LastExecutionSummary (统计信息)
  - ObservedGeneration
end note
cr --> operator: Status Updated
deactivate cr

operator -> operator: Requeue after 1 minute
deactivate operator

== Worker健康检查 ==

note over worker
  Worker Pod通过K8S原生探针保证健康:
  - Liveness Probe: /healthz (每10秒)
  - Readiness Probe: /readyz (每5秒)
  - 失败自动重启,无需手动心跳
end note

@enduml
