apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: datafusion
data:
  01-init-databases.sql: |
    -- 创建数据库
    CREATE DATABASE datafusion_data;
    
  02-init-tables.sql: |
    -- 连接到 datafusion_control 数据库
    \c datafusion_control;
    
    -- 创建任务配置表
    CREATE TABLE IF NOT EXISTS collection_tasks (
        id BIGSERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        type VARCHAR(50) NOT NULL,
        status VARCHAR(50) DEFAULT 'enabled',
        cron VARCHAR(100),
        next_run_time TIMESTAMP,
        replicas INT DEFAULT 1,
        execution_timeout INT DEFAULT 3600,
        max_retries INT DEFAULT 3,
        config TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );
    
    -- 创建任务执行记录表
    CREATE TABLE IF NOT EXISTS task_executions (
        id BIGSERIAL PRIMARY KEY,
        task_id BIGINT REFERENCES collection_tasks(id),
        worker_pod VARCHAR(255),
        status VARCHAR(50),
        start_time TIMESTAMP,
        end_time TIMESTAMP,
        records_collected INT DEFAULT 0,
        error_message TEXT,
        retry_count INT DEFAULT 0
    );
    
    -- 创建索引
    CREATE INDEX IF NOT EXISTS idx_next_run_time ON collection_tasks(next_run_time);
    CREATE INDEX IF NOT EXISTS idx_task_executions_status ON task_executions(task_id, status);
    CREATE INDEX IF NOT EXISTS idx_task_executions_start_time ON task_executions(start_time DESC);
    
  03-insert-test-task.sql: |
    \c datafusion_control;
    
    -- 插入测试任务（API 采集，存储到 PostgreSQL）
    INSERT INTO collection_tasks (name, type, status, cron, next_run_time, replicas, config)
    VALUES (
        'K8S测试-API采集',
        'api',
        'enabled',
        '*/2 * * * *',
        NOW(),
        1,
        '{
            "data_source": {
                "type": "api",
                "url": "https://jsonplaceholder.typicode.com/posts?_limit=5",
                "method": "GET",
                "headers": {},
                "selectors": {
                    "id": "id",
                    "title": "title",
                    "body": "body",
                    "userId": "userId"
                }
            },
            "processor": {
                "cleaning_rules": [
                    {"field": "title", "type": "trim"},
                    {"field": "body", "type": "trim"}
                ],
                "transform_rules": []
            },
            "storage": {
                "target": "postgresql",
                "database": "datafusion_data",
                "table": "test_posts",
                "mapping": {
                    "id": "id",
                    "title": "title",
                    "body": "body",
                    "userId": "user_id"
                }
            }
        }'
    );
    
  04-create-data-tables.sql: |
    \c datafusion_data;
    
    -- 创建测试数据表
    CREATE TABLE IF NOT EXISTS test_posts (
        id INT PRIMARY KEY,
        title VARCHAR(500),
        body TEXT,
        user_id INT,
        created_at TIMESTAMP DEFAULT NOW()
    );
